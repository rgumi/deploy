# This file contains the CI/CD Pipeline in GitLab

variables:
  TAG: $CI_COMMIT_REF_NAME
  PROXY: "http://$WB_HTTP_PROXY_HOST:$WB_HTTP_PROXY_PORT"

stages:
  - build
  - test

cache:
  key: ${CI_COMMIT_REF_SLUG}
  policy: pull-push
  paths:
    - target/

build:docker:
  stage: build
  only:
    refs:
      - master
      - tags
  tags:
    - run_shell
  script:
    - "docker build
      --build-arg HTTP_PROXY=$PROXY
      --build-arg HTTPS_PROXY=$PROXY
      --tag $MTR_URL/depoy:$TAG
      --file Dockerfile ."

    - docker push $MTR_URL/depoy:$TAG
    - docker image rm $MTR_URL/depoy:$TAG

  artifacts:
    paths:
      - target/depoy

    expire_in: 1 hour
